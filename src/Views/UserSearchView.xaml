<UserControl x:Class="VRCGroupTools.Views.UserSearchView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Background="Transparent">
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        
        <!-- Main Content -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,20">
                <TextBlock Text="ðŸ‘¥ User Search &amp; Moderation" 
                           FontSize="24" 
                           FontWeight="Bold" 
                           Foreground="White"/>
                <TextBlock Text="Search any VRChat user by name or User ID, then manage their group membership" 
                           Foreground="#888" 
                           Margin="0,5,0,0"
                           TextWrapping="Wrap"/>
            </StackPanel>
            
            <!-- Search Box -->
            <Grid Grid.Row="1" Margin="0,0,0,15">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBox Grid.Column="0"
                         Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                         materialDesign:HintAssist.Hint="ðŸ” Username or User ID (usr_xxxxxxxx-xxxx-xxxx)"
                         Foreground="White"
                         CaretBrush="White"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         IsEnabled="{Binding IsSearching, Converter={StaticResource InverseBooleanConverter}}">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding SearchCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                
                <Button Grid.Column="1"
                        Content="Search"
                        Command="{Binding SearchCommand}"
                        Click="SearchButton_Click"
                        Width="100"
                        Height="40"
                        Margin="15,0,0,0"
                        Style="{StaticResource MaterialDesignRaisedDarkButton}"
                        Background="#7C4DFF"
                        IsEnabled="{Binding IsSearching, Converter={StaticResource InverseBooleanConverter}}"/>
            </Grid>
            
            <!-- Search Results -->
            <Border Grid.Row="2" Background="#2D2D30" CornerRadius="8" Padding="15">
                <Grid>
                    <!-- Initial state - before any search -->
                    <StackPanel VerticalAlignment="Center" 
                                HorizontalAlignment="Center"
                                Visibility="{Binding HasSearched, Converter={StaticResource InverseBoolToVisConverter}}">
                        <TextBlock Text="ðŸ”" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,15"/>
                        <TextBlock Text="Search for VRChat Users" 
                                   Foreground="White"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Enter a username or User ID above and click Search" 
                                   Foreground="#666"
                                   FontSize="13"
                                   HorizontalAlignment="Center"
                                   Margin="0,8,0,0"/>
                    </StackPanel>

                    <!-- Loading Indicator (only when actively searching) -->
                    <StackPanel VerticalAlignment="Center" 
                                HorizontalAlignment="Center">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsSearching}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <ProgressBar IsIndeterminate="True" Width="200" Height="4" Foreground="#7C4DFF"/>
                        <TextBlock Text="{Binding StatusMessage}" 
                                   Foreground="#888" 
                                   HorizontalAlignment="Center"
                                   Margin="0,15,0,0"/>
                    </StackPanel>
                    
                    <!-- No results found state -->
                    <StackPanel VerticalAlignment="Center" 
                                HorizontalAlignment="Center">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsSearching}" Value="False"/>
                                            <Condition Binding="{Binding HasSearched}" Value="True"/>
                                            <Condition Binding="{Binding SearchResults.Count}" Value="0"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <TextBlock Text="ðŸ˜•" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,15"/>
                        <TextBlock Text="No Users Found" 
                                   Foreground="White"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding StatusMessage}" 
                                   Foreground="#888"
                                   FontSize="13"
                                   HorizontalAlignment="Center"
                                   Margin="0,8,0,0"/>
                    </StackPanel>
                    
                    <!-- Results List (only when not searching and has results) -->
                    <ListBox ItemsSource="{Binding SearchResults}"
                             SelectedItem="{Binding SelectedUser}"
                             Background="Transparent"
                             BorderThickness="0">
                        <ListBox.Style>
                            <Style TargetType="ListBox" BasedOn="{StaticResource {x:Type ListBox}}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsSearching}" Value="False"/>
                                            <Condition Binding="{Binding HasSearched}" Value="True"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ListBox.Style>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="8" Padding="12" Margin="5">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#3D3D40"/>
                                            <Style.Triggers>
                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                                                        <Condition Binding="{Binding DataContext.IsGroupMember, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True"/>
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Background" Value="#2b3f63"/>
                                                </MultiDataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="50"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Avatar -->
                                        <Ellipse Width="40" Height="40" VerticalAlignment="Center">
                                            <Ellipse.Fill>
                                                <ImageBrush ImageSource="{Binding ProfilePicUrl}" Stretch="UniformToFill"/>
                                            </Ellipse.Fill>
                                        </Ellipse>
                                        
                                        <!-- Info -->
                                        <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding DisplayName}" 
                                                       FontWeight="SemiBold" 
                                                       Foreground="White"
                                                       FontSize="14"/>
                                            <TextBlock Text="{Binding UserId}" 
                                                       Foreground="#666" 
                                                       FontSize="10"/>
                                            <TextBlock Text="{Binding StatusDescription}" 
                                                       Foreground="#888" 
                                                       FontSize="11"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxWidth="400"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <ContentPresenter/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </Grid>
            </Border>
            
            <!-- Status Bar -->
            <TextBlock Grid.Row="3" 
                       Text="{Binding StatusMessage}" 
                       Foreground="#888" 
                       Margin="0,10,0,0"/>
        </Grid>
        
        <!-- User Profile Panel -->
        <Border Grid.Column="1" 
                Width="380"
                Background="#252526"
                CornerRadius="8"
                Margin="20,0,0,0"
                Padding="20"
                Visibility="{Binding ShowUserPanel, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Close Button -->
                <Button Grid.Row="0"
                        Content="âœ•"
                        HorizontalAlignment="Right"
                        Command="{Binding CloseUserPanelCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Foreground="#888"
                        Width="30" Height="30"/>
                
                <!-- User Profile Content -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Loading -->
                        <ProgressBar IsIndeterminate="True" 
                                     Margin="0,20,0,0"
                                     Visibility="{Binding IsLoadingUser, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        
                        <!-- Profile Info -->
                        <StackPanel Visibility="{Binding IsLoadingUser, Converter={StaticResource InverseBoolToVisConverter}}">
                            <!-- Avatar -->
                            <Ellipse Width="80" Height="80" 
                                     HorizontalAlignment="Center"
                                     Margin="0,0,0,15">
                                <Ellipse.Fill>
                                    <ImageBrush ImageSource="{Binding SelectedUserProfile.ProfilePicUrl}" 
                                                Stretch="UniformToFill"/>
                                </Ellipse.Fill>
                            </Ellipse>
                            
                            <!-- Display Name -->
                            <TextBlock Text="{Binding SelectedUserProfile.DisplayName}"
                                       FontSize="20"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"/>
                            
                            <!-- Age Verification Badge -->
                            <Border Background="{Binding SelectedUserProfile.IsAgeVerified, Converter={StaticResource BoolToVerifiedColorConverter}}"
                                    CornerRadius="12"
                                    Padding="10,5"
                                    HorizontalAlignment="Center"
                                    Margin="0,10,0,0">
                                <TextBlock Text="{Binding SelectedUserProfile.IsAgeVerified, Converter={StaticResource BoolToVerifiedTextConverter}}"
                                           Foreground="White"
                                           FontSize="12"
                                           FontWeight="SemiBold"/>
                            </Border>
                            
                            <!-- Group Membership Status -->
                            <Border Background="{Binding IsGroupMember, Converter={StaticResource BoolToVerifiedColorConverter}}"
                                    CornerRadius="12"
                                    Padding="10,5"
                                    HorizontalAlignment="Center"
                                    Margin="0,8,0,0">
                                <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="âŒ Not in Group"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsGroupMember}" Value="True">
                                                    <Setter Property="Text" Value="âœ“ Group Member"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Border>
                            
                            <!-- User ID -->
                            <TextBlock Text="{Binding SelectedUserProfile.UserId}"
                                       Foreground="#666"
                                       FontSize="10"
                                       HorizontalAlignment="Center"
                                       Margin="0,10,0,0"/>
                            
                            <!-- Bio -->
                            <Border Background="#1E1E1E" 
                                    CornerRadius="8" 
                                    Padding="12"
                                    Margin="0,15,0,0">
                                <StackPanel>
                                    <TextBlock Text="Bio" Foreground="#888" FontSize="11" Margin="0,0,0,5"/>
                                    <TextBlock Text="{Binding SelectedUserProfile.Bio}"
                                               Foreground="#CCC"
                                               TextWrapping="Wrap"
                                               MaxHeight="100"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Group Actions (only if group is set) -->
                            <StackPanel Visibility="{Binding IsGroupMember, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <!-- Current Roles -->
                                <Border Background="#1E1E1E" 
                                        CornerRadius="8" 
                                        Padding="12"
                                        Margin="0,15,0,0">
                                    <StackPanel>
                                        <TextBlock Text="Current Roles" Foreground="#888" FontSize="11" Margin="0,0,0,8"/>
                                        <ItemsControl ItemsSource="{Binding UserRoles}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#3D3D40" 
                                                            CornerRadius="4" 
                                                            Padding="8,4" 
                                                            Margin="0,0,0,5">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Text="{Binding Name}" 
                                                                       Foreground="#CCC"
                                                                       VerticalAlignment="Center"/>
                                                            <Button Grid.Column="1"
                                                                    Content="âœ•"
                                                                    Command="{Binding DataContext.RemoveRoleCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                    CommandParameter="{Binding}"
                                                                    Style="{StaticResource MaterialDesignFlatButton}"
                                                                    Foreground="#F44336"
                                                                    Width="24" Height="24"
                                                                    Padding="0"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Assign Role -->
                                <Border Background="#1E1E1E" 
                                        CornerRadius="8" 
                                        Padding="12"
                                        Margin="0,15,0,0">
                                    <StackPanel>
                                        <TextBlock Text="Assign Role" Foreground="#888" FontSize="11" Margin="0,0,0,8"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <ComboBox ItemsSource="{Binding GroupRoles}"
                                                      SelectedItem="{Binding SelectedRoleToAssign}"
                                                      DisplayMemberPath="Name"
                                                      Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                                      Foreground="White"/>
                                            <Button Grid.Column="1"
                                                    Content="+"
                                                    Command="{Binding AssignRoleCommand}"
                                                    Width="40" Height="40"
                                                    Margin="10,0,0,0"
                                                    Style="{StaticResource MaterialDesignRaisedDarkButton}"
                                                    Background="#4CAF50"/>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Moderation Actions -->
                                <Border Background="#1E1E1E" 
                                        CornerRadius="8" 
                                        Padding="12"
                                        Margin="0,15,0,0">
                                    <StackPanel>
                                        <TextBlock Text="Moderation Actions" Foreground="#888" FontSize="11" Margin="0,0,0,8"/>
                                        
                                        <Button Content="âš¡ Issue Warning"
                                                Command="{Binding WarnUserCommand}"
                                                Height="36"
                                                Margin="0,0,0,8"
                                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                                Foreground="#FFC107"
                                                BorderBrush="#FFC107"/>
                                        
                                        <Button Content="âš ï¸ Kick from Group"
                                                Command="{Binding KickUserCommand}"
                                                Height="36"
                                                Margin="0,0,0,8"
                                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                                Foreground="#FF9800"
                                                BorderBrush="#FF9800"/>
                                        
                                        <Button Content="ðŸš« Ban from Group"
                                                Command="{Binding BanUserCommand}"
                                                Height="36"
                                                Style="{StaticResource MaterialDesignRaisedDarkButton}"
                                                Background="#F44336"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                            
                            <!-- Not a member message -->
                            <Border Background="#1E1E1E" 
                                    CornerRadius="8" 
                                    Padding="12"
                                    Margin="0,15,0,0"
                                    Visibility="{Binding IsGroupMember, Converter={StaticResource InverseBoolToVisConverter}}">
                                <StackPanel>
                                    <TextBlock Text="This user is not a member of your group. Set a Group ID in the sidebar to manage group members."
                                               Foreground="#888"
                                               TextWrapping="Wrap"
                                               TextAlignment="Center"/>
                                    <Button Content="Invite to Group"
                                            Command="{Binding InviteUserCommand}"
                                            Height="32"
                                            Margin="0,10,0,0"
                                            Style="{StaticResource MaterialDesignOutlinedButton}"
                                            Foreground="#7C9CFF"
                                            BorderBrush="#7C9CFF"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
